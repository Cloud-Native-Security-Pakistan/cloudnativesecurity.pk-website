<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self' https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://api.github.com https://sheets.googleapis.com https://unpkg.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com https://unpkg.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: https://*.openstreetmap.org https://cartodb-basemaps-a.global.ssl.fastly.net; connect-src 'self' https://api.github.com https://sheets.googleapis.com;">
    <title>Members - Cloud Native Security Pakistan</title>
    <link rel="icon" type="image/png" href="/logo.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- DOMPurify -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
        }

        .grid-bg {
            background-image:
                linear-gradient(rgba(0, 255, 0, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;
            /* IE and Edge */
            scrollbar-width: none;
            /* Firefox */
        }

        /* Map custom marker pulse */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.33);
            }

            80%,
            100% {
                opacity: 0;
            }
        }

        @keyframes pulse-dot {
            0% {
                transform: scale(0.8);
            }

            50% {
                transform: scale(1);
            }

            100% {
                transform: scale(0.8);
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col antialiased h-screen overflow-hidden">
    <div id="navbar"></div>

    <main class="flex-grow flex flex-col h-full pt-20">
        <div class="flex-grow flex flex-col md:flex-row h-full overflow-hidden">

            <!-- Sidebar (List + Filters) -->
            <div
                class="w-full md:w-5/12 lg:w-4/12 flex flex-col h-full glass-panel border-r border-white/5 relative z-10">
                <div class="p-6 border-b border-white/5">
                    <h1 class="text-2xl font-bold text-white mb-2">Member Directory</h1>
                    <p class="text-xs text-gray-500 mb-6">Connect with security professionals across
                        Pakistan.</p>

                    <div id="filter-panel"></div>
                </div>

                <div id="members-list-scroll" class="flex-grow overflow-y-auto p-6 space-y-4 custom-scrollbar">
                    <div id="loading" class="text-center py-12">
                        <div
                            class="w-8 h-8 border-2 border-brand-500 border-t-transparent rounded-full animate-spin mx-auto mb-4">
                        </div>
                        <span class="text-gray-500 text-sm">Scanning database...</span>
                    </div>

                    <div id="members-container" class="space-y-4"></div>

                    <div id="no-results" class="hidden text-center py-12 text-gray-500">
                        No members found matching your filters.
                    </div>
                </div>
            </div>

            <!-- Map Area -->
            <div class="hidden md:block w-full md:w-7/12 lg:w-8/12 min-h-screen relative bg-dark-900">
                <div id="map" class="w-full h-full z-0"></div>

                <!-- Map Overlay Gradient -->
                <div
                    class="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-dark-900 to-transparent pointer-events-none z-[400]">
                </div>
            </div>

        </div>
    </main>

    <script type="module">
        import { MemberCard } from './js/MemberCard.js';
        import { FilterPanel } from './js/FilterPanel.js';
        import { Navbar } from './js/Navbar.js';
        import { Map } from './js/Map.js';
        import { fetchData, domReady } from './js/utils.js';

        // Initialize Nav (No footer on this dashboard view)
        new Navbar().init();

        let allMembers = [];
        let mapInstance = null;

        // Load members
        async function loadMembers() {
            const container = document.getElementById('members-container');
            const loading = document.getElementById('loading');
            const noResults = document.getElementById('no-results');

            try {
                // Initialize Map
                mapInstance = new Map('map');
                mapInstance.init();

                // Fetch Data
                allMembers = await fetchData('./data/members.json');
                loading.classList.add('hidden');

                if (!allMembers || allMembers.length === 0) {
                    // Handle empty
                    return;
                }

                // Initial Render
                renderMembers(allMembers);
                mapInstance.updateMarkers(allMembers);

                // Initialize Filters
                new FilterPanel((filters) => {
                    const filtered = allMembers.filter(member => {
                        const cityMatch = !filters.city || member.location?.toLowerCase().includes(filters.city.toLowerCase());
                        const teamMatch = !filters.team || member.team?.toLowerCase() === filters.team.toLowerCase();
                        const skillMatch = !filters.skill || member.interests?.some(i => i.toLowerCase().includes(filters.skill.toLowerCase()));
                        return cityMatch && teamMatch && skillMatch;
                    });

                    renderMembers(filtered);
                    mapInstance.updateMarkers(filtered);
                }).render();

                // Re-render filter panel to inject into DOM (since FilterPanel.render returns string)
                // We need to slightly adjust how FilterPanel is used or manually inject it
                const filterPanel = new FilterPanel((filters) => {
                    const filtered = allMembers.filter(member => {
                        const cityMatch = !filters.city || member.location?.toLowerCase().includes(filters.city.toLowerCase());
                        const teamMatch = !filters.team || member.team?.toLowerCase() === filters.team.toLowerCase();
                        const skillMatch = !filters.skill || member.interests?.some(i => i.toLowerCase().includes(filters.skill.toLowerCase()));
                        return cityMatch && teamMatch && skillMatch;
                    });
                    renderMembers(filtered);
                    mapInstance.updateMarkers(filtered);
                });

                document.getElementById('filter-panel').innerHTML = filterPanel.render();
                filterPanel.setupEventListeners();

                // Update counts
                updateCount(allMembers.length);

            } catch (err) {
                console.error('Error loading members:', err);
                loading.innerHTML = '<p class="text-red-500">CONNECTION LOST</p>';
            }
        }

        function renderMembers(members) {
            const container = document.getElementById('members-container');
            const noResults = document.getElementById('no-results');

            if (members.length === 0) {
                container.innerHTML = '';
                noResults.classList.remove('hidden');
                updateCount(0);
                return;
            }

            noResults.classList.add('hidden');
            container.innerHTML = members.map(member => {
                // Add click handler for map flyTo
                // We add a data attribute to handle interaction
                return new MemberCard(member).render().replace('<article', `<article onclick="window.dispatchEvent(new CustomEvent('member-click', {detail: {lat: ${member.lat}, lng: ${member.lng}}}))" class="cursor-pointer`);
            }).join('');

            // Add event listener for member clicks
            window.addEventListener('member-click', (e) => {
                if (e.detail.lat && e.detail.lng) {
                    mapInstance.flyTo(e.detail.lat, e.detail.lng);
                    // On mobile, maybe switch tab?
                }
            });

            updateCount(members.length);
        }

        function updateCount(count) {
            const el = document.getElementById('member-count');
            if (el) el.textContent = count;
        }

        domReady(loadMembers);
    </script>
</body>

</html>